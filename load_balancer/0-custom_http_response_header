#!/usr/bin/env bash
# This script configures a new Ubuntu server with Nginx and adds a custom X-Served-By HTTP header.
# It also includes all configurations from the previous project (pages, redirect, 404).

# --- Installation (from Task 1) ---
sudo apt-get update -y
sudo apt-get install nginx -y

# --- Page Content ---
echo "Holberton School for the win!" | sudo tee /var/www/html/index.html
echo "Ceci n'est pas une page" | sudo tee /var/www/html/404.html

CONFIG_FILE="/etc/nginx/sites-available/default"

# --- Config for 301 Redirect (from Task 3) ---
REDIRECT_CONFIG="\\\n\tlocation /redirect_me {\n\t\treturn 301 https://www.youtube.com/watch?v=QH2-TGUlwu4;\n\t}"
# Check if redirect is already there before adding it
if ! grep -q "location /redirect_me" "$CONFIG_FILE"; then
    sudo sed -i "/server_name _;/a $REDIRECT_CONFIG" "$CONFIG_FILE"
fi

# --- Config for 404 Page (from Task 4) ---
ERROR_CONFIG="\\\n\terror_page 404 /404.html;\n\tlocation = /404.html {\n\t\troot /var/www/html;\n\t\tinternal;\n\t}"
# Check if 404 config is already there before adding it
if ! grep -q "error_page 404 /404.html;" "$CONFIG_FILE"; then
    sudo sed -i "/index index.html index.htm;/a $ERROR_CONFIG" "$CONFIG_FILE"
fi

# --- NEW Config for Custom Header (Task 0) ---
# Add the X-Served-By header. $hostname is an Nginx variable
HEADER_CONFIG="\\\n\tadd_header X-Served-By \$hostname;"
# Check if header is already there before adding it
if ! grep -q "add_header X-Served-By" "$CONFIG_FILE"; then
    # Add it after the 'server_name _;' line
    sudo sed -i "/server_name _;/a $HEADER_CONFIG" "$CONFIG_FILE"
fi

# Restart nginx
sudo service nginx restart
