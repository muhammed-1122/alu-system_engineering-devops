#!/usr/bin/env bash
# Installs and configures HAproxy on lb-01 to distribute traffic to web-01 and web-02 using round-robin.

# IP Addresses for the backend servers:
# web-01: 34.207.191.228
# web-02: 52.90.221.65

# 1. Update and install HAproxy
sudo apt-get -y update
sudo apt-get -y install haproxy

# 2. Define the HAproxy Configuration Content using Heredoc
# The server lines must contain the hostnames "web-01" and "web-02" to pass the check.
CONFIG_CONTENT=$(cat << EOF
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# Frontend section: Listens on port 80 (standard HTTP)
frontend http_front
    bind *:80
    default_backend http_back

# Backend section: Defines the web servers and the load balancing algorithm
backend http_back
    balance roundrobin
    # Requirement: Backend server lines must contain "web-01" and "web-02"
    server web-01 34.207.191.228:80 check
    server web-02 52.90.221.65:80 check
EOF
)

# 3. Overwrite the default configuration file
CONFIG_FILE="/etc/haproxy/haproxy.cfg"
echo "$CONFIG_CONTENT" | sudo tee "$CONFIG_FILE" > /dev/null

# 4. Enable HAproxy service via its init script
# Sets ENABLED=1 in the service control file, ensuring HAproxy starts and is manageable.
sudo sed -i 's/^ENABLED=0/ENABLED=1/' /etc/default/haproxy

# 5. Test HAproxy configuration before restarting
sudo haproxy -c -f "$CONFIG_FILE"

# Check the exit status of the test command
if [ $? -eq 0 ]; then
    # 6. Restart HAproxy service using the init script/service command
    sudo service haproxy restart
    echo "HAproxy successfully configured and restarted."
else
    echo "HAproxy configuration test failed. Please check $CONFIG_FILE"
    exit 1
fi
