#!/usr/bin/env bash
# This script configures Nginx to run as the 'nginx' user and listen on port 8080.

NGINX_CONF="/etc/nginx/nginx.conf"
SITE_AVAIL="/etc/nginx/sites-available/default"
SITE_ENABLED="/etc/nginx/sites-enabled/default"

# 1. Ensure the 'nginx' system user exists
if ! id "nginx" &>/dev/null; then
    sudo useradd -r -M -s /sbin/nologin nginx
fi

# 2. GUARANTEE 'user nginx;' is in the main context
# Remove any existing user line first, then insert the correct one at the top.
sudo sed -i '/^\s*user\s\+[^;]\+;/d' "$NGINX_CONF"
if ! grep -q "^user nginx;" "$NGINX_CONF"; then
    sudo sed -i '1auser nginx;' "$NGINX_CONF"
fi

# 3. Change 'listen' port to 8080 in the main config (safety)
sudo sed -i '0,/listen [0-9]\{1,5\};/s/listen [0-9]\{1,5\};/listen 8080;/' "$NGINX_CONF"

# 4. Change 'listen' port to 8080 in the default site configuration (overrides)
sudo sed -i '/listen 80;/d' "$SITE_AVAIL"
sudo sed -i '/listen [::]:80;/d' "$SITE_AVAIL"

if ! grep -q "listen 8080;" "$SITE_AVAIL"; then
    sudo sed -i '/^server {/a \        listen 8080;' "$SITE_AVAIL"
    sudo sed -i '/^server {/a \        listen [::]:8080;' "$SITE_AVAIL"
fi

if [ ! -L "$SITE_ENABLED" ]; then
    sudo ln -sf "$SITE_AVAIL" "$SITE_ENABLED"
fi

# 5. Test Configuration and Restart Nginx
sudo nginx -t

if [ $? -eq 0 ]; then
    sudo fuser -k 8080/tcp 2>/dev/null
    sudo service nginx restart
fi

# --- Checks ---
if pgrep -u nginx nginx &>/dev/null; then
    echo "Nginx is running as nginx user."
else
    echo "Nginx is NOT running as nginx user."
fi

if nc -z 0 8080 2>/dev/null; then
    echo "Nginx is listening on port 8080."
else
    echo "Nginx is NOT listening on port 8080."
fi
