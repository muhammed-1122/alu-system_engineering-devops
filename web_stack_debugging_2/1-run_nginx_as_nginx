#!/usr/bin/env bash
# This script configures Nginx to run as the 'nginx' user and listen on port 8080.

NGINX_CONF="/etc/nginx/nginx.conf"
SITE_AVAIL="/etc/nginx/sites-available/default"
SITE_ENABLED="/etc/nginx/sites-enabled/default"

if ! id "nginx" &>/dev/null; then
    sudo useradd -r -M -s /sbin/nologin nginx
fi

sudo sed -i.bak 's/^\s*user www-data;/user nginx;/g' "$NGINX_CONF"
sudo sed -i.bak 's/^\s*user nobody;/user nginx;/g' "$NGINX_CONF"
if ! grep -q "^user nginx;" "$NGINX_CONF"; then
    sudo sed -i '1auser nginx;' "$NGINX_CONF"
fi

sudo sed -i '0,/listen [0-9]\{1,5\};/s/listen [0-9]\{1,5\};/listen 8080;/' "$NGINX_CONF"

sudo sed -i 's/listen 80;/listen 8080;/g' "$SITE_AVAIL"
sudo sed -i 's/listen [::]:80;/listen [::]:8080;/g' "$SITE_AVAIL"

if [ ! -L "$SITE_ENABLED" ]; then
    sudo ln -sf "$SITE_AVAIL" "$SITE_ENABLED"
fi

sudo chown -R nginx:nginx /var/log/nginx
if [ -d "/var/lib/nginx" ]; then
    sudo chown -R nginx:nginx /var/lib/nginx
fi

sudo nginx -t

if [ $? -eq 0 ]; then
    sudo pkill -f nginx || true
    sleep 1
    sudo service nginx start
fi

if pgrep -u nginx nginx &>/dev/null; then
    echo "Nginx is running as nginx user."
else
    echo "Nginx is NOT running as nginx user."
fi

if nc -z 0 8080 2>/dev/null; then
    echo "Nginx is listening on port 8080."
else
    echo "Nginx is NOT listening on port 8080."
fi
