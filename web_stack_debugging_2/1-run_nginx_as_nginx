#!/usr/bin/env bash
# This script configures Nginx to run as the 'nginx' user and listen on port 8080.

NGINX_CONF="/etc/nginx/nginx.conf"

if ! id "nginx" &>/dev/null; then
    sudo useradd -r -M -s /sbin/nologin nginx
fi

sudo sed -i.bak 's|^\s*user\s*[^;]*;.*|user nginx;|I' "$NGINX_CONF"

if ! grep -q "^user nginx;" "$NGINX_CONF"; then
    sudo sed -i '1auser nginx;' "$NGINX_CONF"
fi

sudo sed -i '0,/listen [0-9]\{1,5\};/s/listen [0-9]\{1,5\};/listen 8080;/' "$NGINX_CONF"

sudo nginx -t

if [ $? -eq 0 ]; then
    sudo systemctl stop nginx || true
    sudo systemctl start nginx
fi
